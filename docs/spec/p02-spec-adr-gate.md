# P02 — Spec/ADR Gate Spec

[LEGEND]
PLUGIN = P02
PURPOSE = Не начинать реализацию без формализованного «что/не что/как проверять/как откатывать».
ARTIFACTS = `docs/spec/p02-spec-adr-gate.md`, `docs/adr/ADR-0001-spec-adr-gate.md`
WITNESS = `./dx ci-fast --dry-run`

[CONTENT]
## Goal
Ввести обязательный gate P02 для стартовой фазы изменений:
- реализация кода разрешена только при наличии и наличии валидных Spec/ADR документов;
- все элементы `Goal`, `Non-goals`, `Acceptance`, `Edge-cases`, `Rollback` должны быть подтверждаемы машинно;
- проверка должна выполняться через compas gate как предикат перед прогоном тестов/линтов.

## Non-goals
- P02 не внедряет дополнительную бизнес-логику предметной области проекта;
- P02 не заменяет code review и ручную оценку архитектуры;
- P02 не добавляет новые компиляторные или runtime проверки в продуктовый код приложения;
- P02 не меняет существующие правила компиляции и форматирование репозитория.

## Acceptance
- При запуске `./dx gate ci_fast` для PR, затрагивающего `docs/spec/**` или `docs/adr/**`, в последовательность должен входить `spec-check`;
- `spec-check` должен валидировать наличие двух артефактов (`docs/spec/p02-spec-adr-gate.md`, `docs/adr/ADR-0001-spec-adr-gate.md`) и обязательных секций внутри каждого;
- плагин P02 должен существовать только через `plugin.toml` и подключать `tools/custom/spec-check/tool.toml`;
- конфигурация compas должна содержать impact-правило, связывающее изменения `docs/spec/**` и `docs/adr/**` с `spec-check`;
- любой сбой валидации Spec/ADR должен приводить к fail gate с явным блокирующим нарушением.

## Edge-cases
- Отсутствует один из файлов: gate должен падать и возвращать список проблем;
- Файл существует, но отсутствует раздел: fail с указанием конкретной секции и пути;
- Документ содержит разделы, но с разным регистром (`Goal`, `goal`) — допускается fail-safe нормализация через case-insensitive проверку;
- Удаление или массовые изменения в `docs/spec/**`/`docs/adr/**` без этих разделов должны останавливать pipeline до тестов;
- Повреждённый JSON-вывод или ошибка чтения файла трактуются как fail.

## Rollback
- Если gate блокирует без бизнес-необходимых причин: откатить правки P02 в `quality_contract.toml` для временного снятия обязательности (до triage) и зафиксировать инцидент;
- Перевести `spec-check` в `ci_fast` через отдельный emergency commit только после согласованного решения и с явным rationale в `docs/spec/p02-spec-adr-gate.md`;
- Восстановить штатный путь по шагам: исправить недостающие секции, запустить `./dx ci-fast --dry-run`, затем повторно включить `spec-check`.
